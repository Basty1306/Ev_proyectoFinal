{% extends 'base.html' %}
{% block title %}Panel del Turno{% endblock %}
{% block content %}
<style>
  .wrap { max-width: 1000px; margin: 32px auto; padding: 0 16px; }
  h2 { color:#a78bfa; margin-bottom: 8px; text-align:center; }
  p.sub { color:#94a3b8; text-align:center; margin:4px 0 16px; }

  .msg { text-align:center; margin:8px 0; }
  .msg.ok  { color:#34d399; }
  .msg.err { color:#f87171; }

  .card { background:#1f2937; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.3); margin-bottom:16px; }
  .card h3 { color:#e5e7eb; margin:0 0 10px; font-size:18px; }

  label { display:block; color:#cbd5e1; font-size:14px; margin-bottom:6px; }
  input[type="text"], select {
    width:100%; height:38px; background:#111827; border:1px solid #374151; border-radius:8px;
    color:#f3f4f6; padding:0 10px; box-sizing:border-box;
  }
  input[readonly] { opacity:.85; }

  .btn{ background:#a78bfa; color:#111827; border:none; padding:9px 14px; border-radius:8px; cursor:pointer; font-weight:700; }
  .btn:hover{ background:#8b5cf6; color:#fff; }
  .btn-ghost{ background:#111827; border:1px solid #a78bfa; color:#a78bfa; }
  .btn-ghost:hover{ background:#0c1220; border-color:#8b5cf6; color:#fff; }
  .btn-danger{ background:#ef4444; color:#fff; }
  .btn-danger:hover{ background:#dc2626; }

  table { width:100%; border-collapse:collapse; margin-bottom:10px; }
  th, td { padding:10px 12px; border-bottom:1px solid #374151; text-align:left; }
  th { color:#a78bfa; }

  .badge { display:inline-block; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:700; }
  .b-ok { background:#34d399; color:#062e22; }
  .b-info { background:#60a5fa; color:#0a2540; }

  .legend { display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:13px; color:#cbd5e1; }
  .legend > span { display:inline-flex; gap:6px; align-items:center; }
</style>

<div class="wrap">
  <h2>Panel del Turno</h2>
  <p class="sub">Verificaci√≥n de jugadores por RUT, validaci√≥n de edad por serie y pertenencia a club.</p>

  {% if messages %}
    {% for message in messages %}
      <div class="msg {% if message.tags == 'success' %}ok{% else %}err{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <!-- Selecci√≥n de Partido -->
  <div class="card">
    <h3>Seleccionar Partido</h3>
    <form method="get" action="{% url 'panel_turno' %}" style="display:flex; flex-wrap:wrap; gap:8px;">
      <select name="partido_id" id="id_partido" style="flex:1;">
        <option value="">‚Äî Selecciona ‚Äî</option>
        {% for p in partidos_turno %}
          <option value="{{ p.0 }}" {% if partido_id and p.0 == partido_id %}selected{% endif %}>
            #{{ p.0 }} ‚Äî {{ p.1|date:"Y-m-d" }} {{ p.2|default:"‚Äî" }} ‚Äî {{ p.3 }} vs {{ p.4 }} {% if p.7 %}‚Äî [{{ p.7 }}]{% endif %}
          </option>
        {% endfor %}
      </select>
      <button class="btn" type="submit">Cargar</button>
      <a class="btn-ghost" href="{% url 'panel_turno' %}">Limpiar</a>
    </form>

    {% if partido_id %}
      <p class="sub" style="margin-top:10px;">
        <b>Partido #{{ partido_id }}</b> ‚Äî <b>{{ club_local_txt|default:"‚Äî" }}</b> vs <b>{{ club_visita_txt|default:"‚Äî" }}</b>
        {% if partido_serie_nombre %} ‚Äî Serie: <b>{{ partido_serie_nombre }}</b>{% endif %}
      </p>
    {% endif %}
  </div>

  <!-- Ingreso de Jugador -->
  <div class="card">
    <h3>Agregar Jugador a la N√≥mina</h3>
    <form method="post" style="display:flex; flex-wrap:wrap; gap:12px;">
      {% csrf_token %}
      <input type="hidden" name="id_partido" value="{{ partido_id|default:'' }}">
      <div style="flex:1;">
        <label>RUT</label>
        <input type="text" name="rut" id="rut" placeholder="12345678" inputmode="numeric" pattern="[0-9]{6,8}" required>
      </div>
      <div style="width:80px;">
        <label>DV</label>
        <input type="text" name="dv" id="dv" placeholder="K/0-9" maxlength="1" pattern="[0-9Kk]" required>
      </div>
      <div style="width:100px;">
        <label>Camiseta</label>
        <input type="text" name="camiseta" id="camiseta" placeholder="N¬∞" inputmode="numeric" pattern="[0-9]{1,3}" required>
      </div>
      <div style="flex:1;">
        <label>Serie</label>
        <select name="id_serie" id="id_serie" required>
          <option value="">‚Äî Selecciona ‚Äî</option>
          {% for s in series %}
            <option value="{{ s.0 }}" {% if partido_id_serie and s.0 == partido_id_serie %}selected{% endif %}>{{ s.1 }}</option>
          {% endfor %}
        </select>
      </div>
      <div style="align-self:flex-end;">
        <button type="submit" name="agregar" value="1" class="btn">Agregar</button>
      </div>
    </form>
  </div>

  <!-- N√≥mina verificada -->
  <div class="card">
    <h3>N√≥mina Verificada</h3>

    {% if partido_id %}
      <!-- Local -->
      <h4 style="margin-top:12px;color:#e5e7eb;">
        üè† Local: <b>{{ club_local_txt|default:"‚Äî" }}</b>
        <span class="badge b-info">{{ nomina_local|length }} jugadores</span>
      </h4>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>RUT</th>
              <th>Nombre</th>
              <th>Serie</th>
              <th>Camiseta</th>
              <th>Edad</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for j in nomina_local %}
              <tr>
                <td>{{ j.rut }}-{{ j.dv }}</td>
                <td>{{ j.nombre }}</td>
                <td>{{ j.serie }}</td>
                <td>{{ j.camiseta }}</td>
                <td>{{ j.edad }}</td>
                <td>
                  <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="id_partido" value="{{ partido_id }}">
                    <input type="hidden" name="rut" value="{{ j.rut }}">
                    <input type="hidden" name="dv" value="{{ j.dv }}">
                    <button class="btn-danger" type="submit" name="eliminar" value="1">Eliminar</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6">No hay jugadores del local.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Visita -->
      <h4 style="margin-top:24px;color:#e5e7eb;">
        üõ´ Visita: <b>{{ club_visita_txt|default:"‚Äî" }}</b>
        <span class="badge b-info">{{ nomina_visita|length }} jugadores</span>
      </h4>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>RUT</th>
              <th>Nombre</th>
              <th>Serie</th>
              <th>Camiseta</th>
              <th>Edad</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for j in nomina_visita %}
              <tr>
                <td>{{ j.rut }}-{{ j.dv }}</td>
                <td>{{ j.nombre }}</td>
                <td>{{ j.serie }}</td>
                <td>{{ j.camiseta }}</td>
                <td>{{ j.edad }}</td>
                <td>
                  <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="id_partido" value="{{ partido_id }}">
                    <input type="hidden" name="rut" value="{{ j.rut }}">
                    <input type="hidden" name="dv" value="{{ j.dv }}">
                    <button class="btn-danger" type="submit" name="eliminar" value="1">Eliminar</button>
                  </form>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="6">No hay jugadores de la visita.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="sub">Selecciona un partido para ver su n√≥mina.</p>
    {% endif %}
  </div>

  <div style="text-align:center;margin-top:1rem;">
    <a href="{% url 'dashboard' %}" style="color:#a78bfa;">‚Üê Volver al Panel</a>
  </div>
</div>

<script>
  // Normalizaci√≥n de inputs
  document.addEventListener('input', (e) => {
    if (e.target.id === 'rut') e.target.value = e.target.value.replace(/\D/g,'').slice(0,8);
    if (e.target.id === 'dv') e.target.value = e.target.value.replace(/[^0-9Kk]/g,'').toUpperCase().slice(0,1);
    if (e.target.id === 'camiseta') e.target.value = e.target.value.replace(/\D/g,'').slice(0,3);
  });
</script>
{% endblock %}
